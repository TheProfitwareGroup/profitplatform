/**
 * Module dependencies
 */

var options = require('options.js'),
    ef_sysid = 'EventFlow [ProfitPlatform ' + options.version +
        '] (' + options.platform_host + ':' + options.platform_port + ')';
var schema = require('core/schema.js').initme(__filename);
var utils = require('connect').utils,
    jsonrpc = require('core/jsonrpc.js'),
    db = require('core/db.js'),
    rpc = require('core/rpc.js'),
    Sync = require('sync');

var main = {};

/**
 * Schema: app.eventflow.document.add
 *
 * Document processing
 *
 * @param {Object} document
 * @return {Object}
 * @api public
 */

main[schema] = function (apikey, document, result) {
    Sync(function () {
        var checkstate = rpc.local.sync(rpc, 'app.eventflow.document.check', [apikey, document]);
        if (checkstate.valid) {
            try {
                document.history.push({
                    sysid: ef_sysid,
                    status: 'accepted',
                    date_ts: new Date()
                });
                document.status = 'accepted';
            } catch (e) {
                document.history = [
                    {
                        sysid: ef_sysid,
                        status: 'created',
                        date_ts: new Date()
                    }
                ];
                document.status = 'created';
            }
            if (db.emit.sync(db, 'schema', '[app.eventflow]document.add', document)) {
                return rpc.local.sync(rpc, 'app.eventflow.document.status', [apikey, document]);
            }
        }
    }, result);
};

exports.main = main;