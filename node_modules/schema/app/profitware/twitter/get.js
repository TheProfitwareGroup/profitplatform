var options = require('options.js')

var schema = require('core/schema.js').initme(__filename);
var db = require('core/db.js'),
    jsonrpc = require('core/jsonrpc.js'),
    http = require('http');

var main = {};
var delta = 30000; // Milliseconds between updates

/**
 * Schema: app.profitware.twitter.get
 * 
 * Gets twitter cache
 * 
 * @return {Object}
 */

main[schema] = function(apikey, result) {
    db.emit('schema', '[app.profitware]twitter.find', {}, function(err, obj){
        var found = true;
    	if(err||obj===null){
            found = false;
        } else {
        	if(obj.length == 0)
        		found = false;
        	else
        		if(new Date() - obj[0].date > 30000)
        			found = false;
        }
    	if(!found) {
    		var options = {
                host : 'api.twitter.com',
                port : 80,
                path : '/1/statuses/user_timeline.json?include_entities=true&include_rts=true&screen_name=ProfitwareGroup&count=10'
            };
    		var req = http.get(options, function(res) {
    			var pageData = '';
    		    res.setEncoding('utf8');
    		    res.on('data', function (chunk) {
    			      pageData += chunk;
    		    });
    		    res.on('end', function(){
    		    	var parsedJSON = JSON.parse(pageData);
    		    	db.emit('schema', '[app.profitware]twitter.add', {content : parsedJSON, date : new Date()}, function(err, obj){
    		    		result(null, parsedJSON);
    		    	});
    		    });
    		});
    	} else {
    		result(null, obj[0].content);
    	}
    });
};


exports.main = main;