var options = require('options.js');

var schema = require('core/schema.js').initme(__filename);
var db = require('core/db.js'),
    jsonrpc = require('core/jsonrpc.js'),
    http = require('http'),
    smsdb = require('./db/' + options.db.type + '.js');

var main = {};

/**
 * Schema: smsc.sendsms
 *
 * Sends SMS message through smsc.ru
 *
 * @return {Object}
 */

main[schema] = function (apikey, user, phone, message, result) {
    smsdb.getSender(user, function (err, obj) {
        if (err || obj === null) {
            return result({ message: err }, null);
        } else {
            var options = {
                host: 'smsc.ru',
                port: 80,
                path: '/sys/send.php?fmt=3&charset=utf-8&login=' + user
                    + '&sender=' + encodeURIComponent(obj.sender)
                    + '&psw=' + encodeURIComponent(obj.password) + '&phones=' + phone + '&mes=' + encodeURIComponent(message)
            };
            http.get(options,function (res) {
                res.on('data', function (chunk) {
                    result(null, JSON.parse(chunk));
                });
            }).on('error', function (err) {
                    result({ message: err.message }, null);
            });
        }
    });
    return;
};

exports.main = main;
exports.install = function (installInfo, result) {
    smsdb.emit('install', installInfo.smsSenders, result);
};
