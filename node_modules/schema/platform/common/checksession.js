var schema = require('core/schema.js').initme(__filename);
var db = require('core/db.js'),
    jsonrpc = require('core/jsonrpc.js');

var main = {};

/**
 * Schema: platform.common.checksession
 *
 * Returns platform options
 *
 * @return {Object}
 */

main[schema] = function (apikey, result) {
    db.emit('schema', 'session.find', { session: apikey }, function (err, obj) {
        if (err || obj === null)
            result(jsonrpc.INVALID_APIKEY, null);
        else {
            if (obj.needrelogin) {
                db.emit('schema', 'session.delete', { session: obj.session }, function (err, obj) {
                    result(jsonrpc.NEED_RELOGIN, null);
                });
            } else {
                db.emit('schema', 'session.update', { session: apikey, user: obj.user[0] }, function (err, obj) {
                    result(null, "success");
                });
            }
        }
    });
};

exports.main = main;