var l = require('core/logger.js'),
	schema = require('core/schema.js').initme(__filename);
var db = require('core/db.js'),
    jsonrpc = require('core/jsonrpc.js');

var main = {};

/**
 * Schema: platform.common.schemalist
 * 
 * Returns an array of schemas that can be accessed with roles
 * identified by apikey
 * 
 * @return {Object}
 */

main[schema] = function(apikey, result) {
    db.emit('schema', 'session.find', {session : apikey}, function(err, obj){
        if(err||(obj===null)){
            result(jsonrpc.INVALID_APIKEY);  
        }else{
            l.trace('schema.platform.common.schemalist', 'Has roles');
            l.trace('schema.platform.common.schemalist', obj.user[0].roles);
            db.emit('schema', 'schema.find', {level: obj.user[0].roles}, function(err, schemaName){
            	db.emit('schema', 'profile.find', { name : obj.user[0].profile }, function(err, aSchemas) {
	                var resSchemas = [];
	                schemaName.forEach(function(sc) {
	                	if(aSchemas.indexOf(sc) >= 0) {
	                		resSchemas.push(sc);
	                	}
	                });
            		if(err||(schemaName===null)){
	                    result(jsonrpc.DATABASE_ERROR);  
	                }else{
	                    result(null, resSchemas);
	                }            		
            	});

            });
        }
    });
};

exports.main = main;